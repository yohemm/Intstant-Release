name: Test Semantic Versioning Action

on:
  push:
    branches: [main, develop]
  pull_request:
  workflow_dispatch:

# âœ… CLÃ‰S: Permissions explicites pour le token GitHub
permissions:
  contents: write      # Pour committer et crÃ©er des releases
  pull-requests: read  # Pour les PRs
  id-token: write  # nÃ©cessaire si tu fais des OIDC logins
  actions: read    # lecture des actions, si nÃ©cessaire

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout avec credentials persistantes
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          # âœ… IMPORTANT: Persister les credentials pour git push
          persist-credentials: true
      
      # 3. Tester l'action avec elle-mÃªme
      - name: Test Action (Debug Mode)
        id: semantic_action
        uses: ./
        with:
          debug: 'true'
          generate-changelog: 'true'
          auto-commit: 'false'
          create-tags: 'false'
      
      # 4. VÃ©rifier les outputs
      - name: Check Action Outputs
        run: |
          echo "ğŸ“Œ New Version: ${{ steps.semantic_action.outputs.new-version }}"
          echo "ğŸ“Š Bump Type: ${{ steps.semantic_action.outputs.version-bump }}"
          echo "ğŸ“ Changelog Generated: ${{ steps.semantic_action.outputs.changelog-generated }}"
          echo "ğŸ·ï¸ Tag Created: ${{ steps.semantic_action.outputs.tag-created }}"
          echo "ğŸ“ Current Version: ${{ steps.semantic_action.outputs.current-version }}"
      
      # 5. VÃ©rifier le fichier CHANGELOG
      - name: Verify Changelog File
        run: |
          if [ -f "CHANGELOG.md" ]; then
            echo "âœ… CHANGELOG.md created successfully"
            echo ""
            echo "ğŸ“‹ Content preview:"
            head -50 CHANGELOG.md
          else
            echo "âš ï¸ CHANGELOG.md not found"
            ls -la
          fi
      
      # 6. VÃ©rifier les tags Git
      - name: Verify Git Tags
        run: |
          echo "ğŸ“Œ Local tags:"
          git tag -l
          echo ""
          echo "ğŸ“Œ Recent commits:"
          git log --oneline -10
      
      # 7. RÃ©sumÃ© du test
      - name: Test Summary
        run: |
          echo "=========================================="
          echo "âœ… Test Completed Successfully"
          echo "=========================================="
          echo "âœ“ Permissions: Verified"
          echo "âœ“ Git Configuration: OK"
          echo "âœ“ Action Executed: OK"
          echo "âœ“ Outputs Captured: OK"
          echo "=========================================="